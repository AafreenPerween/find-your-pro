<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="cspagetittle">Find You Pro | Admin Panel</title>
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <link rel="stylesheet" href="/styledarkmode.css" />
    <style>
      .status-badge {
        width: 100px;
        display: inline-block;
        padding: 3px 18px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: bold;
        text-align: center;
      }

      .pending {
        background-color: #ffc107; /* Yellow */
        color: black;
      }

      .accepted {
        background-color: #28a745; /* Green */
        color: white;
      }

      .rejected {
        background-color: #dc3545; /* Red */
        color: white;
      }

      .completed {
        background-color: #007bff; /* Blue */
        color: white;
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
        </ul>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#"
              ><i class="fas fa-expand-arrows-alt"></i
            ></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="pages/profile.html"
              ><i class="fas fa-user-circle"></i> Admin</a
            >
          </li>
        </ul>
      </nav>

      <!-- Sidebar -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="#" class="brand-link">
          <img
            src="dist/img/AdminLTELogo.png"
            alt="Logo"
            class="brand-image img-circle elevation-3"
          />
          <span class="brand-text font-weight-light">Find You Pro</span>
        </a>
        <div class="sidebar">
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              role="menu"
              data-accordion="false"
            >
              <li class="nav-item">
                <a href="./index.html" class="nav-link active">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Dashboard</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="../admin-panel/pages/workers.html" class="nav-link">
                  <i class="nav-icon fas fa-user-cog"></i>
                  <p>Manage Providers</p>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="../admin-panel/pages/customer-admin.html"
                  class="nav-link"
                >
                  <i class="nav-icon fas fa-users"></i>
                  <p>Manage Customers</p>
                </a>
              </li>
              <li class="nav-item">
                <a
                  href="../admin-panel/pages/service-requests.html"
                  class="nav-link"
                >
                  <i class="nav-icon fas fa-briefcase"></i>
                  <p>Service Requests</p>
                </a>
              </li>
              <!-- <li class="nav-item">
            <a href="../admin-panel/pages/analytics.html" class="nav-link">
              <i class="nav-icon fas fa-chart-line"></i>
              <p>Analytics</p>
            </a>
          </li> -->
              <li class="nav-item">
                <a href="../admin-panel/pages/settings.html" class="nav-link">
                  <i class="nav-icon fas fa-cogs"></i>
                  <p>Settings</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/index.html" class="nav-link">
                  <i class="nav-icon fas fa-sign-out-alt"></i>
                  <p>Logout</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Dashboard</h1>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard content -->
        <section class="content">
          <div class="container-fluid">
            <div class="row">
              <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                  <div class="inner">
                    <h3 id="workerCount">--</h3>
                    <p>Total Providers</p>
                  </div>
                  <div class="icon"><i class="fas fa-user-cog"></i></div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                  <div class="inner">
                    <h3 id="customerCount">--</h3>
                    <p>Total Customers</p>
                  </div>
                  <div class="icon"><i class="fas fa-users"></i></div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                  <div class="inner">
                    <h3 id="pendingRequests">--</h3>
                    <p>Pending Services</p>
                  </div>
                  <div class="icon"><i class="fas fa-tasks"></i></div>
                </div>
              </div>

              <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                  <div class="inner">
                    <h3 id="totalRequests">--</h3>
                    <p>Total Requests</p>
                  </div>
                  <div class="icon"><i class="fas fa-briefcase"></i></div>
                </div>
              </div>
            </div>

            <!-- Service Requests Table -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Recent Service Requests</h3>
              </div>
              <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Customer</th>
                      <th>Provider</th>
                      <th>Status</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="requestTableBody">
                    <!-- Dynamic rows go here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer class="main-footer">
        <strong>&copy; 2025 <a href="#">Find You Pro</a>.</strong> All rights
        reserved.
      </footer>
    </div>

    <!-- Scripts -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="dist/js/adminlte.min.js"></script>
    <script src="./pages/language-switcher.js" defer></script>
    <script>
      const token = localStorage.getItem("adminToken");
      const tableBody = document.getElementById("requestTableBody");

      if (!token) {
        alert("Unauthorized access");
        window.location.href = "login.html";
      } else {
        fetch("/api/admin/dashboard-data", {
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((res) => {
            if (res.status === 401 || res.status === 403) {
              localStorage.removeItem("adminToken");
              window.location.href = "login.html";
            }
            return res.json();
          })
          .then((data) => {
            if (data.success) {
              document.getElementById("workerCount").innerText =
                data.workerCount;
              document.getElementById("customerCount").innerText =
                data.customerCount;
              document.getElementById("pendingRequests").innerText =
                data.pendingRequests;
              document.getElementById("totalRequests").innerText =
                data.totalRequests;

              tableBody.innerHTML = "";
              data.recentRequests.forEach((r) => {
                tableBody.innerHTML += `
              <tr>
                <td>${r.id}</td>
                <td>${r.customer}</td>
                <td>${r.worker}</td>
                <td>${r.status}</td>
                <td>${r.date}</td>
              </tr>`;
              });
            } else {
              tableBody.innerHTML =
                '<tr><td colspan="5">No data found.</td></tr>';
            }
          })
          .catch((err) => {
            console.error("Dashboard Error:", err);
            tableBody.innerHTML =
              '<tr><td colspan="5">Error loading data.</td></tr>';
          });
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.body.classList.toggle("dark-mode", savedTheme === "dark");

        const themeDropdown = document.getElementById("themeMode");
        if (themeDropdown) {
          themeDropdown.value = savedTheme;
          themeDropdown.addEventListener("change", function () {
            const selectedTheme = this.value;
            document.body.classList.toggle(
              "dark-mode",
              selectedTheme === "dark"
            );
            localStorage.setItem("theme", selectedTheme);
          });
        }
      });
    </script>

    // Search functionality
    <script>
      const fetchServiceRequests = async () => {
        try {
          const res = await fetch("/api/admin/dashboard-data", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("adminToken"),
            },
          });
          if (!res.ok) throw new Error("Failed to fetch requests");

          const data = await res.json();
          const tableBody = document.getElementById("requestTableBody");
          tableBody.innerHTML = ""; // Clear previous entries

          data.recentRequests.forEach((r) => {
            const statusClass =
              r.status.toLowerCase() === "pending"
                ? "pending"
                : r.status.toLowerCase() === "accepted"
                ? "accepted"
                : r.status.toLowerCase() === "rejected"
                ? "rejected"
                : "completed"; // Added completed status

            const row = document.createElement("tr");
            row.innerHTML = `
                  <td>${r.id}</td>
                  <td>${r.customer}</td>
                  <td>${r.worker}</td>
                  <td><span class="status-badge ${statusClass}">${r.status}</span></td>
                  <td>${r.date}</td>
              `;
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Error fetching service requests:", err);
        }
      };

      document.addEventListener("DOMContentLoaded", fetchServiceRequests);
    </script>

    <script>
      async function translateText(text, targetLang) {
        const apiKey = "AIzaSyDkiFJ60SAb3Y3YOg3eQHxLUgh4VRMJ24M"; // Replace with your key
        const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify({ q: text, target: targetLang }),
            headers: { "Content-Type": "application/json" },
          });

          const data = await response.json();
          return data.data.translations[0]?.translatedText || text;
        } catch (error) {
          console.error("Translation failed:", error);
          return text;
        }
      }

      document
        .getElementById("languageSwitcher")
        .addEventListener("change", async function () {
          const selectedLang = this.value;
          localStorage.setItem("selectedLang", selectedLang);

          const elementsToTranslate = [
            { id: "title", text: "Find Your Pro" },
            {
              id: "description",
              text: "Your trusted experts for every job - from fixing to flourishing. We have got you covered.",
            },
            { id: "standout-heading", text: "What Makes Us Stand Out" },
            {
              id: "standout-description",
              text: "A combination of technology, trust, and top-tier service to redefine how you connect with local professionals.",
            },
            { id: "easy-to-use", text: "Easy to use" },
            {
              id: "easy-to-use-desc",
              text: "Simple, user-friendly and reliable interface for users.",
            },
            { id: "excellent-service", text: "Excellent service" },
            {
              id: "excellent-service-desc",
              text: "Professionals equipped with the right tools, knowledge, and attitude to deliver outstanding results.",
            },
          ];

          elementsToTranslate.forEach(async (item) => {
            const translatedText = await translateText(item.text, selectedLang);
            document.getElementById(item.id).innerHTML = translatedText;
          });
        });

      document.addEventListener("DOMContentLoaded", async function () {
        const savedLang = localStorage.getItem("selectedLang") || "en";
        document.getElementById("languageSwitcher").value = savedLang;

        const elementsToTranslate = [
          { id: "title", text: "Find Your Pro" },
          {
            id: "description",
            text: "Your trusted experts for every job - from fixing to flourishing. We have got you covered.",
          },
        ];

        elementsToTranslate.forEach(async (item) => {
          const translatedText = await translateText(item.text, savedLang);
          document.getElementById(item.id).innerHTML = translatedText;
        });
      });
    </script>
  </body>
</html>

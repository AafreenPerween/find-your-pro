<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Customer Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        overflow-x: hidden;
      }

      .offcanvas-body a {
        color: white;
        text-decoration: none;
        padding: 0.75rem 1rem;
        display: block;
        border-radius: 5px;
      }

      .offcanvas-body a:hover {
        border: 2px solid #ff9800;
        color: white;
      }

      .offcanvas-body a.active {
        background-color: #ff9800;
        color: white;
      }

      .offcanvas {
        background-color: #102e50;
      }

      .navbar {
        background-color: #102e50;
      }

      .card-img-top {
        height: 200px;
        object-fit: cover;
      }

      .sidebar-link {
        cursor: pointer;
      }

      /* Settings Box */
      .settings-container {
        max-width: 100%;
        background: white; /* Bright contrast */
        padding: 20px;
        margin: 30%;
        margin-top: 3%;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      }
      /* Headings */
      h1 {
        text-align: center;
        color: #0077b6; /* Sea Blue */
        margin-bottom: 20px;
      }

      /* Labels & Inputs */
      label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
        color: #102e50; /* Stylish deep blue */
      }

      select,
      input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        background: #f0f0f0;
      }

      /* Button - Sea Blue */
      .clsbttn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 20px;
        background-color: #0077b6; /* Sea Blue */
        color: white;
        font-size: 16px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      button:hover {
        background-color: #005e94; /* Slightly darker hover effect */
      }

      .dark-mode {
        background-color: #102e50;
        color: white;
      }

      /* Input Fields in Dark Mode */
      .dark-mode select,
      .dark-mode input {
        background-color: #1c3b5d;
        color: white;
        border: 1px solid #004080;
      }

      /* Button */
      button {
        background-color: #0077b6;
        color: white;
        padding: 10px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      button:hover {
        background-color: #005e94;
      }

      .dark-mode {
        background-color: #0b1e38 !important; /* Darker navy blue */
        color: white !important;
      }

      /* Apply Dark Mode to all containers */
      .dark-mode .settings-container,
      .dark-mode .offcanvas,
      .dark-mode .navbar,
      .dark-mode main {
        background-color: #08152a !important; /* Even darker for better contrast */
        border: 1px solid #004080 !important;
      }

      /* Improve Text Visibility */
      .dark-mode h1,
      .dark-mode h2,
      .dark-mode h3,
      .dark-mode h4,
      .dark-mode h5,
      .dark-mode p,
      .dark-mode label {
        color: white !important;
      }

      /* Input Fields in Dark Mode */
      .dark-mode select,
      .dark-mode input {
        background-color: #112443;
        color: white;
        border: 1px solid #004080;
      }

      /* Provider Cards (Explore Page) */
      .dark-mode #providerList .card {
        background-color: #112443 !important;
        color: white !important;
        border: 1px solid #004080 !important;
      }

      /* Buttons */
      .dark-mode button {
        background-color: #fcbf49 !important;
        color: #102e50 !important;
      }

      .dark-mode button:hover {
        background-color: #e09f3e !important;
      }

      .dark-mode {
        background-color: #2e3a4a !important; /* Soft gray with a subtle blue tone */
        color: #ffffff !important; /* Bright white text for perfect contrast */
      }

      /* Navbar & Sidebar */
      .dark-mode .navbar,
      .dark-mode .offcanvas {
        background-color: #37475b !important; /* Slightly lighter for distinction */
        border-bottom: 2px solid #5a718e !important;
      }

      /* Sidebar Links */
      .dark-mode .sidebar-link {
        color: #ffffff !important;
      }

      .dark-mode .sidebar-link:hover {
        background-color: #465b77 !important; /* Gentle hover effect */
      }

      /* Cards & Containers */
      .dark-mode .card,
      .dark-mode .settings-container {
        background-color: #3f4f63 !important; /* Balanced gray-blue */
        border: 1px solid #5a718e !important;
      }

      /* Provider Cards (Explore Page) */
      .dark-mode #providerList .card {
        background-color: #3f4f63 !important;
        color: white !important;
        border: 1px solid #5a718e !important;
      }

      /* Input Fields */
      .dark-mode .form-control,
      .dark-mode select,
      .dark-mode input {
        background-color: #4a5c72 !important;
        color: #ffffff;
        border: 1px solid #6c85a1;
      }

      /* Booking Requests & Availability Tables */
      .dark-mode table.table-bordered {
        background-color: #3f4f63 !important;
        color: #ffffff !important;
        border: 1px solid #5a718e !important;
      }

      .dark-mode table.table-bordered th {
        background-color: #4a5c72 !important;
        color: #ffffff !important;
      }

      /* Alerts & Notifications */
      .dark-mode .alert {
        background-color: #3f4f63 !important;
        color: #ffffff !important;
        border: 1px solid #5a718e !important;
      }

      /* Buttons */
      .dark-mode button {
        background-color: #4c88ff !important; /* Clean, modern blue */
        color: white !important;
        transition: 0.3s ease-in-out;
      }

      .dark-mode button:hover {
        background-color: #3570e5 !important; /* Slightly darker on hover */
      }

      .dark-mode ::placeholder {
        color: white !important;
        opacity: 1; /* Ensure full visibility */
      }

      /* Improve input contrast */
      .dark-mode input,
      .dark-mode select,
      .dark-mode textarea {
        background-color: #4a5c72 !important;
        color: white !important;
        border: 1px solid #6c85a1 !important;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <button
          class="btn btn-outline-light me-2"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#sidebar"
        >
          ‚ò∞
        </button>
        <span class="navbar-brand mb-0 h1 text-white">Customer Dashboard</span>
      </div>
    </nav>

    <!-- Sidebar -->
    <div
      class="offcanvas offcanvas-start show"
      data-bs-backdrop="false"
      tabindex="-1"
      id="sidebar"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title text-white">Menu</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <a href="#" class="sidebar-link active" data-page="explore">Explore</a>
        <a href="#" class="sidebar-link" data-page="bookings">Bookings</a>
        <a href="#" class="sidebar-link" data-page="profile">My Profile</a>
        <a href="#" class="sidebar-link" data-page="settings">Settings</a>
        <a href="#" class="sidebar-link" data-page="help">Help</a>
        <a href="#" class="sidebar-link text-danger" data-page="logout"
          >Logout</a
        >
      </div>
    </div>

    <!-- Main Content -->
    <main class="container-fluid p-4" id="main-content">
      <h1>Welcome!</h1>
      <p>Select a section from the sidebar to get started.</p>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- REPLACE ONLY THE EXISTING SCRIPT SECTION WITH THE FOLLOWING -->
    <script>
      // üîê Redirect if not logged in
      if (!localStorage.getItem("customerToken")) {
        window.location.href = "../index.html";
      }

      const contentMap = {
        explore: `
      <h2>Explore Service Providers</h2>
      <p>Browse and discover available service providers in your area</p>
      <div class="mb-4">
          <label for="serviceFilter" class="form-label">Filter by Service Type</label>
          <select class="form-select" id="serviceFilter">
              <option value="all">All Services</option>
              <option value="electrician">Electrician</option>
              <option value="plumber">Plumber</option>
              <option value="technician">Technician</option>
              <option value="carpenter">Carpenter</option>
              <option value="painter">Painter</option>
          </select>
      </div>
      <div id="providerList" class="row"></div>`,

        bookings: `
      <h2>My Bookings</h2>
      <p>Track current and previous service requests here.</p>`,

        profile: `
      <h2>My Profile</h2>
      <form id="profileForm">
        <div class="col-md-8">
          <div class="mb-2">
            <label for="custName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="custName" disabled />
          </div>
          <div class="mb-2">
            <label for="custEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="custEmail" disabled />
          </div>
          <div class="mb-2">
            <label for="custPhone" class="form-label">Phone</label>
            <input type="tel" class="form-control" id="custPhone" disabled />
          </div>
          <div class="mb-2">
            <label for="custAddress" class="form-label">Address</label>
            <input type="text" class="form-control" id="custAddress" disabled />
          </div>
          <div class="mt-3">
            <button type="button" id="editBtn" class="btn btn-outline-primary">Edit Profile</button>
            <button type="submit" id="saveBtn" class="btn btn-primary d-none">Save Changes</button>
            <button type="button" id="cancelBtn" class="btn btn-secondary d-none">Cancel</button>
          </div>
        </div>
      </form>`,

        settings: `
      <div class="settings-container" class="bodyclssttng" id="rootContainer">
    <h1>Settings</h1>

    <form id="settingsForm">
        <label for="profileName">Full Name</label>
        <input type="text" id="profileName" placeholder="Enter your name">

        <div class="theme-switcher">
        
           <label for="profileName">theme</label>
    <button id="themeToggle">
        <span id="themeIcon">üåû</span> <span id="themeText">Light Mode</span>
    </button>
</div>

        <label for="notificationToggle">Enable Notifications</label>
        <select id="notificationToggle">
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>

        <label for="languageSwitcher">Preferred Language</label>
        <select id="languageSwitcher">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="or">Odia</option>
        </select>

        <button type="submit" class="clsbttn">Save Settings</button>
    </form>
</div>`,

        help: `
      <h2>Help & Support</h2>
      <p>Need help? Contact our support team.</p>
      <ul>
        <li>Email: support@findyourpro.com</li>
        <li>Phone: +1-800-123-4567</li>
      </ul>`,
      };

      const links = document.querySelectorAll(".sidebar-link");
      const mainContent = document.getElementById("main-content");

      links.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          links.forEach((l) => l.classList.remove("active"));
          this.classList.add("active");

          const page = this.getAttribute("data-page");

          if (page === "logout") {
            localStorage.removeItem("customerToken");
            window.location.href = "../index.html";
          } else {
            mainContent.innerHTML =
              contentMap[page] || `<h2>Page not found</h2>`;

            if (page === "profile") {
              setTimeout(loadCustomerProfile, 100);
            } else if (page === "explore") {
              setTimeout(() => {
                loadProviders("all");
                $("#serviceFilter").on("change", function () {
                  loadProviders(this.value);
                });
              }, 100);
            }
          }

          const sidebar = bootstrap.Offcanvas.getInstance(
            document.getElementById("sidebar")
          );
          if (sidebar) sidebar.hide();
        });
      });

      document.querySelector('.sidebar-link[data-page="explore"]').click();

      function toggleProfileEditing(enable) {
        ["custName", "custPhone", "custAddress"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.disabled = !enable;
        });

        document.getElementById("saveBtn").classList.toggle("d-none", !enable);
        document
          .getElementById("cancelBtn")
          .classList.toggle("d-none", !enable);
        document.getElementById("editBtn").classList.toggle("d-none", enable);
      }

      async function loadCustomerProfile() {
        const token = localStorage.getItem("customerToken");

        try {
          const res = await fetch("/api/customer/dashboard/profile", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();

          if (data.success && data.customer) {
            const customer = data.customer;
            document.getElementById("custName").value = customer.name || "";
            document.getElementById("custEmail").value = customer.email || "";
            document.getElementById("custPhone").value = customer.phone || "";
            document.getElementById("custAddress").value =
              customer.address || "";
            toggleProfileEditing(false);
          } else {
            alert("Failed to load profile data.");
          }
        } catch (err) {
          console.error("Failed to load customer profile:", err);
        }
      }

      document.addEventListener("click", function (e) {
        if (e.target.id === "editBtn") toggleProfileEditing(true);
        if (e.target.id === "cancelBtn") {
          loadCustomerProfile();
          toggleProfileEditing(false);
        }
      });

      document.addEventListener("submit", async function (e) {
        if (e.target.id === "profileForm") {
          e.preventDefault();
          const token = localStorage.getItem("customerToken");

          const payload = {
            name: document.getElementById("custName").value,
            phone: document.getElementById("custPhone").value,
            address: document.getElementById("custAddress").value,
          };

          try {
            const res = await fetch("/api/customer/dashboard/profile", {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const result = await res.json();
            alert(result.message || "Profile updated successfully.");
            loadCustomerProfile();
          } catch (err) {
            console.error(err);
            alert("Failed to update profile.");
          }
        }
      });

      function loadProviders(serviceType = "all") {
        $.ajax({
          url: `/api/providers?service=${serviceType}`,
          method: "GET",
          success: function (data) {
            const providerList = $("#providerList");
            providerList.empty();

            data.forEach((provider) => {
              providerList.append(`
            <div class="col-md-4 mb-4 px-5">
              <div class="card shadow-sm">
                <img src="/uploads/providers/${
                  provider.profile_pic || "default.jpg"
                }" 
                     class="card-img-top" style="height: 200px; object-fit: cover;" 
                     alt="${provider.name}">
                <div class="card-body">
                  <h5 class="card-title">${provider.name}</h5>
                  <p class="card-text">Service: ${provider.service_type}</p>
                  <!-- <p class="card-text">Rating: ${
                    provider.avg_rating
                  }</p> -->
                  <button class="btn btn-primary view-provider-btn" data-provider="${
                    provider.provider_id
                  }">View Profile</button>
                </div>
              </div>
            </div>
          `);
            });
          },
        });
      }
      $(document).on("click", ".view-provider-btn", async function () {
        const providerId = $(this).data("provider");

        try {
          const res = await fetch(`/api/providers/${providerId}`);
          const providerData = await res.json();

          if (providerData.success && providerData.provider) {
            const provider = providerData.provider;

            // ‚úÖ Fetch provider availability
            const availabilityRes = await fetch(
              `/api/provider/${providerId}/availability`
            );
            const availabilityData = await availabilityRes.json();

            if (!availabilityData.success) {
              console.error("Failed to fetch provider availability");
              return alert("Unable to load availability data.");
            }
            window.currentAvailableSlots = {};
            availabilityData.availability.forEach(
              ({ date, time_slot, is_available }) => {
                if (is_available) {
                  if (!window.currentAvailableSlots[date]) {
                    window.currentAvailableSlots[date] = [];
                  }
                  window.currentAvailableSlots[date].push(time_slot);
                }
              }
            );

            const availableDates = new Set();
            const availableSlots = {};

            // ‚úÖ Process availability
            availabilityData.availability.forEach(
              ({ date, time_slot, is_available }) => {
                if (is_available) {
                  availableDates.add(date);
                  if (!availableSlots[date]) availableSlots[date] = [];
                  availableSlots[date].push(time_slot);
                }
              }
            );

            // ‚úÖ Inject booking form into DOM
            mainContent.innerHTML = `
        <div class="row">
          <div class="col-md-4">
            <img src="/uploads/providers/${
              provider.profile_pic || "default.jpg"
            }" class="img-fluid rounded" />
          </div>
          <div class="col-md-8">
            <h2>${provider.name}</h2>
            <p><strong>Service:</strong> ${provider.service_type}</p>
            <p><strong>Experience:</strong> ${provider.experience} years</p>
            <p><strong>Address:</strong> ${provider.address}</p>

            <h4>Leave a Booking Request</h4>
            <p class="text-muted">Only available dates & time slots are selectable.</p>

            <form id="bookingForm">
              <input type="hidden" name="provider_id" value="${
                provider.provider_id
              }" />

              <div class="mb-2">
                <label class="form-label">Preferred Date</label>
                <select name="preferred_date" class="form-select" id="preferred_date" required>
                  ${[...availableDates]
                    .map((date) => `<option value="${date}">${date}</option>`)
                    .join("")}
                </select>
              </div>

              <div class="mb-2">
                <label for="preferred_time">Preferred Time Slot</label>
                <select id="preferred_time" name="preferred_time" class="form-select" disabled required>
                  <option value="">Select Time Slot</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Problem Statement</label>
                <textarea name="problem_statement" class="form-control"></textarea>
              </div>

              <button type="submit" class="btn btn-success">Submit Request</button>
            </form>
          </div>
        </div>
      `;

            // ‚úÖ Store available slots for later use in the delegated handler
          }
        } catch (err) {
          console.error("Failed to fetch provider details:", err);
          alert("Something went wrong while loading the provider profile.");
        }
      });

      // ‚úÖ Delegate time slot loading to a dynamic change event
      // ‚úÖ Save slots globally for access during change event

      // ‚úÖ Populate time slots when preferred date changes
      $(document).on("change", "#preferred_date", function () {
        const selectedDate = this.value;
        const timeSlotDropdown = $("#preferred_time");

        console.log("Selected date:", selectedDate);
        console.log(
          "Available slots for date:",
          window.currentAvailableSlots?.[selectedDate]
        );

        timeSlotDropdown
          .empty()
          .append(`<option value="">Select Time Slot</option>`);

        if (
          window.currentAvailableSlots &&
          window.currentAvailableSlots[selectedDate]
        ) {
          window.currentAvailableSlots[selectedDate].forEach((slot) => {
            timeSlotDropdown.append(`<option value="${slot}">${slot}</option>`);
          });
          timeSlotDropdown.prop("disabled", false);
        } else {
          console.warn("No available slots for selected date.");
          timeSlotDropdown.prop("disabled", true);
        }
      });

      // ‚úÖ Handle form submission
      $(document).on("submit", "#bookingForm", async function (e) {
        e.preventDefault();
        const token = localStorage.getItem("customerToken");

        const formData = {
          provider_id: this.provider_id.value,
          preferred_date: document.getElementById("preferred_date").value,
          preferred_time: document.getElementById("preferred_time").value,
          problem_statement: this.problem_statement.value,
        };

        try {
          const res = await fetch("/api/customer/dashboard/book", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(formData),
          });

          const result = await res.json();
          alert(result.message || "Booking request submitted successfully!");
        } catch (err) {
          console.error(err);
          alert("Failed to submit booking request.");
        }
      });
    </script>

    <script>
      // Function to wait for an element before running logic
      function waitForElement(selector, callback) {
        const element = document.querySelector(selector);
        if (element) {
          callback(element);
        } else {
          setTimeout(() => waitForElement(selector, callback), 100); // Retry every 100ms
        }
      }

      // Apply the theme (Dark or Light)
      function applyTheme(theme) {
        document.documentElement.classList.toggle(
          "dark-mode",
          theme === "dark"
        );
        localStorage.setItem("theme", theme);

        const themeIcon = document.getElementById("themeIcon");
        const themeText = document.getElementById("themeText");

        if (themeIcon && themeText) {
          themeIcon.textContent = theme === "dark" ? "üåô" : "üåû";
          themeText.textContent = theme === "dark" ? "Dark Mode" : "Light Mode";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const savedTheme = localStorage.getItem("theme") || "light";

        function applyTheme(theme) {
          document.documentElement.classList.toggle(
            "dark-mode",
            theme === "dark"
          );
          localStorage.setItem("theme", theme);

          const themeIcon = document.getElementById("themeIcon");
          const themeText = document.getElementById("themeText");

          if (themeIcon && themeText) {
            themeIcon.textContent = theme === "dark" ? "üåô" : "üåû";
            themeText.textContent =
              theme === "dark" ? "Dark Mode" : "Light Mode";
          }
        }

        applyTheme(savedTheme); // Apply theme immediately

        function attachToggleListener() {
          waitForElement("#themeToggle", function (themeToggle) {
            themeToggle.removeEventListener("click", toggleTheme); // Ensure we don‚Äôt duplicate events
            themeToggle.addEventListener("click", toggleTheme);
          });
        }

        function toggleTheme() {
          const newTheme = document.documentElement.classList.contains(
            "dark-mode"
          )
            ? "light"
            : "dark";
          applyTheme(newTheme);
        }

        // ‚úÖ Reattach Toggle Listener Every Time Settings Page Loads
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", function () {
            setTimeout(() => {
              applyTheme(localStorage.getItem("theme") || "light");
              attachToggleListener(); // Ensure toggle button remains functional
            }, 200);
          });
        });

        // ‚úÖ Keep reattaching the event listener whenever content updates dynamically
        const observer = new MutationObserver(() => {
          attachToggleListener(); // Ensure toggle works even after switching pages
        });

        observer.observe(document.getElementById("main-content"), {
          childList: true,
          subtree: true,
        });
      });

      // Ensure theme is applied when switching pages dynamically
      function applyThemeOnPageSwitch() {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);
      }

      // Update theme when switching between pages dynamically
      document.querySelectorAll(".sidebar-link").forEach((link) => {
        link.addEventListener("click", function () {
          setTimeout(applyThemeOnPageSwitch, 200); // Apply theme after page update
        });
      });
    </script>
  </body>
</html>

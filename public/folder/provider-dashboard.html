<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Provider Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        overflow-x: hidden;
      }

      .offcanvas-body a {
        color: white;
        text-decoration: none;
        padding: 0.75rem 1rem;
        display: block;
        border-radius: 5px;
      }

      .offcanvas-body a:hover {
        border: 2px solid #ff9800;
        color: white;
      }

      .offcanvas-body a.active {
        background-color: #ff9800;
        color: white;
      }

      .offcanvas {
        background-color: #102e50;
      }

      .navbar {
        background-color: #102e50;
      }

      .profile-pic-preview:hover {
        opacity: 0.85;
      }

      .profile-pic-label {
        position: relative;
        display: inline-block;
        cursor: pointer;
      }

      .profile-pic-preview {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 3px solid #ddd;
        transition: 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .upload-text {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        pointer-events: none;
        opacity: 0.9;
      }

      .disabled-edit {
        pointer-events: none;
        opacity: 0.6;
      }

      .alert {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <button
          class="btn btn-outline-light me-2"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#sidebar"
        >
          ‚ò∞
        </button>
        <span class="navbar-brand mb-0 h1 text-white">Provider Dashboard</span>
      </div>
    </nav>

    <!-- Offcanvas Sidebar -->
    <div
      class="offcanvas offcanvas-start show"
      data-bs-backdrop="false"
      tabindex="-1"
      id="sidebar"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title text-white">Menu</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <a href="#" class="sidebar-link active" data-page="requests"
          >Booking Requests</a
        >
        <a href="#" class="sidebar-link" data-page="history">Booking History</a>
        <a href="#" class="sidebar-link" data-page="reviews"
          >Reviews & Ratings</a
        >
        <a href="#" class="sidebar-link" data-page="availability"
          >Manage Availability</a
        >
        <a href="#" class="sidebar-link" data-page="profile">My Profile</a>
        <a href="#" class="sidebar-link" data-page="settings">Settings</a>
        <a href="#" class="sidebar-link" data-page="help">Help</a>
        <a href="#" class="sidebar-link text-danger" data-page="logout"
          >Logout</a
        >
      </div>
    </div>

    <!-- Main Content Area -->
    <main class="container-fluid p-4" id="main-content">
      <h1>Welcome!</h1>
      <p>Select a section from the sidebar to get started.</p>
      <!-- Error and success messages -->
      <div id="alert-container"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts -->
    <script>
      // üîê Redirect to login page if not logged in
      if (!localStorage.getItem("providerToken")) {
        window.location.href = "../index.html";
      }

      const contentMap = {
        requests: `<h2>Booking Requests</h2><p>View and respond to incoming service requests from customers.</p>`,
        history: `<h2>Booking History</h2><p>Review all your completed and past service bookings.</p>`,
        reviews: `<h2>Reviews & Ratings</h2><p>Check what customers are saying about your services.</p>`,
        availability: `<h2>Manage Availability</h2><p>Update your working hours, days off, and availability status here.</p>`,
        profile: `
          <h2>My Profile</h2>
          <form id="profileForm" class="row g-3">
            <div class="col-md-4 text-center">
              <label for="profilePic" class="profile-pic-label disabled">
                <img
                  src="default-profile.jpg"
                  alt="Profile Picture"
                  id="profilePicPreview"
                  class="profile-pic-preview"
                  onerror="this.src='default-profile.jpg'"
                />
                <input
                  type="file"
                  class="d-none"
                  id="profilePic"
                  accept="image/*"
                />
              </label>
            </div>
            <div class="col-md-8">
              <div class="mb-2">
                <label for="provName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="provName" disabled />
              </div>
              <div class="mb-2">
                <label for="provEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="provEmail" disabled />
              </div>
              <div class="mb-2">
                <label for="provPhone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="provPhone" disabled />
              </div>
              <div class="mb-2">
                <label for="provAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="provAddress" disabled />
              </div>
              <div class="mb-2">
                <label for="provService" class="form-label">Service Type</label>
                <input type="text" id="provService" name="service_type" class="form-control" disabled>
              </div>
              <div class="mb-2">
                <label for="provExperience" class="form-label">Experience (Years)</label>
                <input type="number" class="form-control" id="provExperience" min="1" max="50" disabled />
              </div>
              <div class="mt-3">
                <button type="button" id="editBtn" class="btn btn-outline-primary">Edit Profile</button>
                <button type="submit" id="saveBtn" class="btn btn-primary d-none">Save Changes</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary d-none">Cancel</button>
              </div>
            </div>
          </form>
        `,
        settings: `<h2>Settings</h2><p>Configure your account preferences, notification settings, and privacy controls.</p>`,
        help: `<h2>Help & Support</h2><p>Need assistance? Contact our team for support.</p><ul><li>Email: support@findyourpro.com</li><li>Phone: +1-800-123-4567</li></ul>`,
      };

      const links = document.querySelectorAll(".sidebar-link");
      const mainContent = document.getElementById("main-content");
      const alertContainer = document.getElementById("alert-container");

      links.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          links.forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          const page = this.getAttribute("data-page");

          if (page === "logout") {
            localStorage.removeItem("providerToken");
            window.location.href = "../index.html";
          } else {
            mainContent.innerHTML =
              contentMap[page] || `<h2>Page not found</h2>`;
            if (page === "profile") {
              setTimeout(loadProviderProfile, 100);
            }
          }

          const sidebar = bootstrap.Offcanvas.getInstance(
            document.getElementById("sidebar")
          );
          if (sidebar) sidebar.hide();
        });
      });

      document.querySelector('.sidebar-link[data-page="requests"]').click();

      function toggleProfileEditing(enable) {
        [
          "provName",
          "provPhone",
          "provAddress",
          "provExperience",
          "profilePic",
        ].forEach((id) => {
          document.getElementById(id).disabled = !enable;
        });
        document
          .getElementById("profilePic")
          .classList.toggle("d-none", !enable);
        document.getElementById("saveBtn").classList.toggle("d-none", !enable);
        document
          .getElementById("cancelBtn")
          .classList.toggle("d-none", !enable);
        document.getElementById("editBtn").classList.toggle("d-none", enable);
      }

      async function loadProviderProfile() {
        const token = localStorage.getItem("providerToken");

        try {
          const res = await fetch("/api/provider/dashboard/profile", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();

          if (data.success && data.provider) {
            const provider = data.provider;

            document.getElementById("provName").value = provider.name || "";
            document.getElementById("provEmail").value = provider.email || "";
            document.getElementById("provPhone").value = provider.phone || "";
            document.getElementById("provAddress").value =
              provider.address || "";
            document.getElementById("provService").value =
              provider.service_type || "";
            document.getElementById("provExperience").value =
              provider.experience || "";

            const profileImage = provider.profile_pic
              ? `http://localhost:5000/uploads/providers/${provider.profile_pic}`
              : "default-profile.jpg";

            document.getElementById("profilePicPreview").src = profileImage;

            document
              .getElementById("profilePic")
              .addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                  document.getElementById("profilePicPreview").src =
                    URL.createObjectURL(file);
                }
              });

            toggleProfileEditing(false);
          } else {
            alert("Failed to load profile data.");
          }
        } catch (err) {
          console.error("Failed to load provider profile:", err);
          showAlert("danger", "Failed to load profile data.");
        }
      }

      function showAlert(type, message) {
        const alertHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <strong>${message}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        alertContainer.innerHTML = alertHTML;
      }

      document.addEventListener("click", function (e) {
        if (e.target.id === "editBtn") toggleProfileEditing(true);
        if (e.target.id === "cancelBtn") {
          loadProviderProfile();
          toggleProfileEditing(false);
        }
      });

      document.addEventListener("submit", async function (e) {
        if (e.target.id === "profileForm") {
          e.preventDefault();
          const token = localStorage.getItem("providerToken");

          const formData = new FormData();
          formData.append("name", document.getElementById("provName").value);
          formData.append("phone", document.getElementById("provPhone").value);
          formData.append(
            "address",
            document.getElementById("provAddress").value
          );
          formData.append(
            "experience",
            document.getElementById("provExperience").value
          );

          const pic = document.getElementById("profilePic").files[0];
          if (pic) formData.append("profile_pic", pic);

          try {
            const res = await fetch("/api/provider/dashboard/profile", {
              method: "PUT",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            });

            const result = await res.json();
            showAlert(
              "success",
              result.message || "Profile updated successfully."
            );
            loadProviderProfile();
          } catch (err) {
            console.error(err);
            showAlert("danger", "Failed to update profile.");
          }
        }
      });
    </script>
  </body>
</html>
